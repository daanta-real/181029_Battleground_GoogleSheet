// ë£¨í”„ 3. loop_system(ìê¸°ì¥,ë ˆë“œì¡´,ê³µì¤‘ë³´ê¸‰,ì„ ë¬¼ ë“±ì˜ ì²˜ë¦¬) 
//////////////// S1(ìê¸°ì¥) > S2(ë ˆë“œì¡´) > S3(ê³µì¤‘ë³´ê¸‰) ìˆœìœ¼ë¡œ ë˜ì–´ìˆìŒ.
//////////////// ì„ ë¬¼ì€ ì¼ì¼íŠ¸ë¦¬ê±° ë³„ë„ ì…‹íŒ…ì—°ê²°ëœ í•¨ìˆ˜ë¡œ ì²˜ë¦¬


function loop_system(player, matzip, currTurn) {
  // ë³€ìˆ˜ì¤€ë¹„
  var logtxt = []; // ëª¨ë“  ì§„í–‰ê¸°ë¡ì´ ë‹´ê¸°ëŠ” ë¶€ë¶„
  
  //////////////////////////////////////////////////////////////////////////////////////////
  /// ì‹œìŠ¤í…œ 1. ìê¸°ì¥
  var magLooped = loop_system_mag(player, matzip, currTurn); // [logtxt, player, matzip] ë¦¬í„´ë°›ìŒ
  if(magLooped[0] != 'ì—†ìŒ') {
    logtxt = logtxt.concat(magLooped[0]); // ì „ì²´ ë¡œê·¸í…ìŠ¤íŠ¸ì— ìê¸°ì¥ë¡œê·¸ ì¶”ê°€ (magLooped[0])
    //logtxt.push("ìê¸°ì¥ ë");
    //debugConsoleLog("[ê¸°ë¡ì˜ˆì •:ìê¸°ì¥]");
    //debugConsoleLog(magLooped[0]);// ìê¸°ì¥ë¡œê·¸ ê¸°ë¡ì˜ˆì • ë©”ì„¸ì§€ í‘œì‹œ
  }
  player = magLooped[1]; // í”Œë ˆì´ì–´ ëŒë ¤ë°›ìŒ
  matzip = magLooped[2]; // ë§›ì§‘ ëŒë ¤ë°›ìŒ
  
  //////////////////////////////////////////////////////////////////////////////////////////
  /// ì‹œìŠ¤í…œ 2. ë ˆë“œì¡´
  var redLooped = loop_system_red(player, currTurn); // [logtxt, player] ë¦¬í„´ë°›ìŒ
  if(redLooped[0] != 'ì—†ìŒ') {
    logtxt = logtxt.concat(redLooped[0]); // ì „ì²´ ë¡œê·¸í…ìŠ¤íŠ¸ì— ë ˆë“œì¡´ë¡œê·¸ ì¶”ê°€ (redLooped[0])
    //logtxt.push("ë ˆë“œì¡´ ë");
    //debugConsoleLog("[ê¸°ë¡ì˜ˆì •:ë ˆë“œì¡´]");
    //debugConsoleLog(redLooped[0]); // ë ˆë“œì¡´ë¡œê·¸ ê¸°ë¡ì˜ˆì • ë©”ì„¸ì§€ í‘œì‹œ
  }
  player = redLooped[1]; // í”Œë ˆì´ì–´ ëŒë ¤ë°›ìŒ
  
  //////////////////////////////////////////////////////////////////////////////////////////
  /// ì‹œìŠ¤í…œ 3. ê³µì¤‘ë³´ê¸‰
  var gifted = loop_system_giftBox();
  if(gifted != 'ì—†ìŒ') {
    logtxt = logtxt.concat(gifted); // ì „ì²´ ë¡œê·¸í…ìŠ¤íŠ¸ì— ê³µì¤‘ë³´ê¸‰ë¡œê·¸ ì¶”ê°€ (gifted[0])
    //logtxt.push("ê³µì¤‘ë³´ê¸‰ ë");
    //debugConsoleLog("[ê³µì¤‘ë³´ê¸‰ë]ê¸°ë¡ì˜ˆì •: " + gifted.length + ", gifted = " + gifted + ", gifted[0] = " + gifted[0] + ", logtxt = " + logtxt+"]]"); // ê³µì¤‘ë³´ê¸‰ë¡œê·¸ ê¸°ë¡ì˜ˆì • ë©”ì„¸ì§€ í‘œì‹œ
  }
  
  //////////////////////////////////////////////////////////////////////////////////////////
  // ë‹¤ ì²˜ë¦¬í–ˆìœ¼ë©´ ì‹œìŠ¤í…œ ë¡œê·¸ë©”ì„¸ì§€ ëª¨ì•„ì„œ ìµœì¢…ë°°ì—´ ë§Œë“ ë‹´ì— return
  if(logtxt.length == 0) var logtxts = 'ì—†ìŒ';
  else {
    var logtxts = [];
    for(var i in logtxt) {
      logtxts.push([logtxt[i], currTurn]);
    }
  }
  return [logtxts, player, matzip];
}


function loop_system_mag(player, matzip, currTurn) {
  //////////////////////////////////////////////////////////////////////////////////////////
  /// ì‹œìŠ¤í…œ 1. ìê¸°ì¥ ì²˜ë¦¬
  var logtxt = [];
  
  // 1. í„´ì¡°ê±´ ì•ˆë§ì„ ê²½ìš° ì¡°ìš©íˆ ë¦¬í„´ì²˜ë¦¬
  // 1-1) 10í„´ ë¯¸ë§Œë¯¸ë©´ ë¦¬í„´
  if(currTurn < magStart) return ['ì—†ìŒ', player, matzip];
  // 1-2) í„´ì´ 10í„´ì´ë‚˜ ê·¸ ì´í›„ë¼ë©´, ì¦‰ ì‹¤í–‰ì¡°ê±´ì´ ë§ë‹¤ë©´ ìê¸°ì¥ ë¡œë“œ
  var mag = readZone('ìê¸°ì¥');
  var currMag = readZone('ìê¸°ì¥');
  
  // 2. ìê¸°ì¥ ë²”ìœ„ë‚´ í”Œë ˆì´ì–´ ì²´í¬í•´ì„œ ì˜ì—­ë°– ì• ë“¤ ì „ë¶€ HP-1 ê¹ìŒ
  // ìˆœì„œëŠ” ëœë¤ìœ¼ë¡œ í•´ì„œ ê¹ê³  ë§ˆì§€ë§‰ í”Œë ˆì´ì–´ëŠ” ì£½ì´ì§€ ì•ŠëŠ”ë‹¤.
  // ì‚´ì•„ìˆëŠ” ì¸ì›ìˆ˜ë¥¼ êµ¬í•¨
  if (mag != 'ì—†ìŒ') { // ìê¸°ì¥ì´ ì—†ëŠ”ê±° ì•„ë‹ê²½ìš°
    player.sort(function() { return Math.random() - Math.random(); }); // í”Œë ˆì´ì–´ ì „ì²´ ë°°ì—´ ëœë¤ ì íŒ…
    for(var i in player) { // ëª¨ë“  ëœë¤ì íŒ…ëœ í”Œë ˆì´ì–´ì— ëŒ€í•˜ì—¬
      if(player[i][11] > 0) { // í”¼ê°€ ìˆëŠ” í”Œë ˆì´ì–´ë“¤ë§Œ ëŒ€ìƒìœ¼ë¡œ 
        var txt = player[i][1]+player[i][2]+'ìê¸°ì¥ í”¼ì ê²€-';
        var deadChk = 0;

        // ì¡°ê±´1. í”Œë ˆì´ì–´ê°€ ìê¸°ì¥ ì§€ì§€ëŠ” ì§€ì í˜¹ì€ ê·¸ë°”ê¹¥ì˜ì—­ì— ë°œì„ ë””ë””ê³ ìˆê±°ë‚˜.
        if(player[i][15] <= mag[0][0]) deadChk++, txt += "ì•ˆì „ì§€ëŒ€ì˜ ìœ„ìª½ì„) "; 
        if(player[i][15] >= mag[1][0]) deadChk++, txt += "ì•ˆì „ì§€ëŒ€ì˜ ì•„ë˜ìª½ì„) ";
        if(player[i][16] <= mag[0][1]) deadChk++, txt += "ì•ˆì „ì§€ëŒ€ì˜ ì™¼ìª½ì„) ";
        if(player[i][16] >= mag[1][1]) deadChk++, txt += "ì•ˆì „ì§€ëŒ€ì˜ ì˜¤ë¥¸ìª½ì„) ";
        
        // ì¡°ê±´2. ìê¸°ì¥ì´ ì „ì²´ìê¸°ì¥ì¼ê²½ìš°, HP ì‚­ê°ëŒ€ìƒì´ë‹¤.
        if(mag == 'ì „ì²´') deadChk++, txt += "ì•ˆì „ì§€ëŒ€ê°€ ì•„ì˜ˆ ì—†ìŒ) ";
        
        if(deadChk > 0) { // HP ì‚­ê°ì²˜ë¦¬ ì‹œì‘
          txt+= 'ì‚­ê°ì²˜ë¦¬í•©ë‹ˆë‹¤.';
          var lives = 0; for(var j in player) if(player[j][11] > 0) lives++; // ìƒì¡´ì ëª…ìˆ˜(HP 1 ì´ìƒìˆëŠ”ë†ˆ ëª…ìˆ˜ ) êµ¬í•´ì„œ
          //log(player[i][1]+player[i][2]+': ìƒì¡´ì ëª…ìˆ˜ëŠ” ' + lives + "ëª…ì´ë‹¤!");
          if(lives >= 2) { // ìƒì¡´ììˆ˜ê°€ 2 ì´ìƒì´ë©´
            //log(player[i][1]+player[i][2]+': ìƒì¡´ì 2ëª…ì´ìƒì´ì–´ì„œ í”¼ê¹Œê¸°ë¶€ ë“¤ì–´ì™”ë‹¤! í”¼ë¥¼ê¹ë‹¤.');
            player[i][11] --; // í”¼ 1ê¹Œê¸° (1ëª…ë‚¨ì•˜ìœ¼ë©´ ë”ì´ìƒ ì•ˆê¹œ)
            if (player[i][11] > 0) {
              //log(player[i][1]+player[i][2]+'ëŠ” ìê¸°ì¥ ë§ê³  í”¼1ê¹Œì˜€ì§€ë§Œ ì‚´ì•˜ë‹¤.');              
              logtxt.push(/*txt*/ player[i][1] + player[i][2] + ": ì•„í£! ìê¸°ì¥ì˜ ë§›ì€ ë„ˆë¬´ ì•„í”„êµ¬ë‚˜! (â¤ï¸ï¸-1)"); // ìê¸°ì¥ ë§ê³  ì‚´ì•˜ì„ë•Œ
            }
            else {
              //log(player[i][1]+player[i][2]+'ëŠ” ìê¸°ì¥ ë§ê³  í”¼1ê¹Œì—¬ì„œ í”¼ê°€ 0ë¼ì„œ ì£½ì—ˆë‹¤.');
              logtxt.push(/*txt*/ "ğŸŒìê¸°ì¥ğŸ’¥ğŸ’¥ğŸ’¥" + 'â˜ ï¸' + player[i][2] + " "+player[i][1] + "ë‚˜ ì¤‘ëŠ¥ê²…ê°€....âš°ï¸ğŸ˜‡ï¸âš°ï¸ğŸ˜‡ï¸âš°ï¸ğŸ˜‡ï¸"); // ìê¸°ì¥ ë§ê³  ì‚¬ë§ ì‹œ ë©˜íŠ¸
              for(var k in player) if(player[k][26]==i) player[k][26]='x'; // í˜¹ì‹œ ì´ì‹œì ì—ì„œ í•´ë‹¹ í”Œë ˆì´ì–´ê°€ ì£½ì—¬ì„œ ë£¨íŒ…í•´ì•¼ ë˜ëŠ” ì‹œì²´(ì •ë²Œì)ê°€ ìˆë‹¤ë©´, ëª¨ë‘ ì—†ì• ë²„ë¦°ë‹¤.
              player[i][25] = currTurn; // ì£½ì€ ì‹œì ì˜ í„´ì„ í”Œë ˆì´ì–´ ë°°ì—´ì— ê¸°ë¡ì²˜ë¦¬
            }
          }
        } // HP ì‚­ê°ì²˜ë¦¬ ë
        //log(txt);
      } // hp ìˆëŠ” í”Œë ˆì´ì–´ ëŒ€ìƒ IFë¬¸ ë
    } // í”Œë ˆì´ì–´ë‹¹ forë¬¸ ì²˜ë¦¬ ë
    player.sort(function(a, b) { return a[0] - b[0]; }); // í”Œë ˆì´ì–´ ì „ì²´ ë°°ì—´ idx ì •ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì¬ë³µêµ¬
  }
  
  // ì‹¤í–‰í™•ë¥  = ì‚¬ëŒ ê½‰ì°¼ì„ë•Œ 30% ì‚¬ëŒ ì ì„ë•Œ 100%
  var lives = 0; for(var j in player) if(player[j][11] > 0) lives++; // ìƒì¡´ì ëª…ìˆ˜(HP 1 ì´ìƒìˆëŠ”ë†ˆ ëª…ìˆ˜ ) êµ¬í•´ì„œ
  var perc = 50 + 60 * ((maxlives - lives) / maxlives);
  if(randomPercent(perc) == true) {  
    // 3. ìê¸°ì¥ì´ ì—†ë‹¤ë©´, ìê¸°ì¥ì„ ì‹¬ì–´ì¤€ë‹¤.
    if(mag == 'ì—†ìŒ') mag = [[0,0], [20,21]];
    
    // 4. ìê¸°ì¥ ë²”ìœ„ ë³€ê²½: 10í„´ì´í›„ 6í„´ë§ˆë‹¤ í•œë²ˆì”© ìê¸°ì¥ í•œì¹¸ ì „ì§„ì²˜ë¦¬(í”Œë ˆì´ì–´ ìµœì´ˆ ì›€ì§ì´ê³  ë‚œ ì´í›„)
    if(mag != 'ì „ì²´') {
    
      // ìê¸°ì¥ ëª¨ì–‘(ì„¸ë¡œì°Œë¶€, ê°€ë¡œì°Œë¶€, ì •ì‚¬ê°í˜•)ì— ë”°ë¼ì„œ ìê¸°ì¥ ì „ì§„ë°©í–¥ì„ ì •í•´ì¤Œ
      var magHeight = Math.abs((mag[1][0] - 1) - mag[0][0]);
      var magWidth = Math.abs((mag[1][1] - 1) - mag[0][1]);
      var rnd = '';
      
      // ë†’ì´ê°€ ë„ˆë¹„ë³´ë‹¤ í´ ê²½ìš° (ì¦‰ ì„¸ë¡œë¡œ ì§œë¶€ ì‹œ) ROWë¥¼ ì¢í˜€ì¤€ë‹¤.
      // ROWë¥¼ ì–´ë””ë¡œ ì¢íˆëŠëƒëŠ” 0 > ì•„ë˜ë¡œ ì „ì§„(+) // 1 > ìœ„ë¡œ ì „ì§„(-)
      if(magHeight > magWidth) {
        var modification = getmagRCModifications()[0];
        var rand = Math.random();
        if(rand + modification > 0.5) rnd = 0; // ì•„ë˜ë¡œ
        else rnd = 1; // ìœ„ë¡œ
      }
      
      // ë„ˆë¹„ê°€ ë†’ì´ì™€ ê°™ê±°ë‚˜ í´ ê²½ìš° (ì¦‰ ê°€ë¡œë¡œ ì§œë¶€ ì‹œê±°ë‚˜, ì •ì‚¬ê°í˜•ì´ê±°ë‚˜) COLì„ ì¢í˜€ì¤€ë‹¤.
      // ROWë¥¼ ì–´ë””ë¡œ ì¢íˆëŠëƒëŠ” 2 > ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì „ì§„(+) // 3 > ì™¼ìª½ìœ¼ë¡œ ì „ì§„(-)
      else {
        var modification = getmagRCModifications()[1];
        var rand = Math.random();
        if(rand + modification > 0.5) rnd = 2; // ì˜¤ë¥¸ìª½ìœ¼ë¡œ
        else rnd = 3; // ì™¼ìª½ìœ¼ë¡œ
      }
      
      switch(rnd) {
        case 0: mag[0][0]++; logtxt.push("ğŸŒìê¸°ì¥ì´ ì•„ë˜ìª½ìœ¼ë¡œ 1ì¹¸ ì¢í˜€ì˜¤ê³  ìˆìŠµë‹ˆë‹¤! " + zoneTxt(currMag) +" â‡’ " + zoneTxt(mag)); break;
        case 1: mag[1][0]--; logtxt.push("ğŸŒìê¸°ì¥ì´ ìœ„ìª½ìœ¼ë¡œ 1ì¹¸ ì¢í˜€ì˜¤ê³  ìˆìŠµë‹ˆë‹¤! " + zoneTxt(currMag) +" â‡’ " + zoneTxt(mag)); break;
        case 2: mag[0][1]++; logtxt.push("ğŸŒìê¸°ì¥ì´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ 1ì¹¸ ì¢í˜€ì˜¤ê³  ìˆìŠµë‹ˆë‹¤! " + zoneTxt(currMag) +" â‡’ " + zoneTxt(mag)); break;
        case 3: mag[1][1]--; logtxt.push("ğŸŒìê¸°ì¥ì´ ì™¼ìª½ìœ¼ë¡œ 1ì¹¸ ì¢í˜€ì˜¤ê³  ìˆìŠµë‹ˆë‹¤! " + zoneTxt(currMag) +" â‡’ " + zoneTxt(mag)); break;
        default: break;/////////////// ë°˜í™˜í˜•íƒœ: [ ì¢Œìƒì²«ìœ„í—˜ì [r , c] , ìš°í•˜ì²«ìœ„í—˜ì [r , c] ]
      }
      
      // 5. ìê¸°ì¥ ë°–ì—ìˆëŠ” ë§›ì§‘ ì˜¬ false
      for(var k in matzip) {
        if(matzip[k][4] <= mag[0][0]
           || matzip[k][4] >= mag[1][0]    // ë§›ì§‘ì˜ ROWì¢Œí‘œê°€ ìê¸°ì¥ ì¢Œì²«ìœ„í—˜ì  ì´í•˜ê±°ë‚˜ ìš°ì²«ìœ„í—˜ì  ì´ìƒì„ (=ì¢Œìš°ë¡œ ìê¸°ì¥ì„  ë°”ê¹¥ìª½)
           || matzip[k][5] <= mag[0][1]
           || matzip[k][5] >= mag[1][1]) { // ë§›ì§‘ì˜ COLì¢Œí‘œê°€ ìê¸°ì¥ ìƒì²«ìœ„í—˜ì  ì´í•˜ê±°ë‚˜ í•˜ì²«ìœ„í—˜ì  ì´ìƒì„ (=ìƒí•˜ë¡œ ìê¸°ì¥ì„  ë°”ê¹¥ìª½)
          if(matzip[k][6] == true) logtxt.push(matzip[k][2]+matzip[k][3] + " ì§€ì—­ì´ ğŸŒìê¸°ì¥ì— ì ê²¨ë²„ë ¸ë‹¤!"); // ì‹ ê·œë¡œ ì ê¸°ëŠ” ë§›ì§‘ë§Œ í…ìŠ¤íŠ¸ í‘œì‹œ
          for(var l = 6; l < matzip[k].length; l++) matzip[k][l] = false;
        }
      }
      
      //log(mag[0][0] + ", " + mag[0][1] + ", " + mag[1][0] + ", " + mag[1][1]);
      if(Math.abs(mag[0][0] - mag[1][0]) == 1 || Math.abs(mag[0][1] - mag[1][1]) == 1) {
        logtxt.push("ğŸš¨ğŸš¨ğŸš¨ ìê¸°ì¥ì´ ëª¨ë“  ì˜ì—­ì„ ë®ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë” ì´ìƒ ì•ˆì „ì§€ëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸš¨ğŸš¨ğŸš¨");
        mag = 'ì „ì²´';
      }
    }
    // 6. ë³€ê²½ëœ ìê¸°ì¥ ë° ë¡œê·¸ ê¸°ë¡
    
    writeZone('ìê¸°ì¥', mag);
    
  } else if(logtxt.length == 0) logtxt = 'ì—†ìŒ'; // ìê¸°ì¥ ë°”ë€ŒëŠ” í„´ì´ ì•„ë‹ˆë©´ì„œ ìê¸°ì¥ì— ë‹¹í•œì‚¬ëŒë„ ì•„ë¬´ë„ ì—†ë‹¤ë©´ logtxtë¥¼ []ì—ì„œ 'ì—†ìŒ'ìœ¼ë¡œ ë°”ê¿”ì¤€ë‹¤.
  
  return [logtxt, player, matzip]; // ìê¸°ì¥ìœ¼ë¡œ ë§ì•„ì£½ì€ ì¸ì›ì´ ìˆìœ¼ë©´ ì´ì‹œì ì—ì„œ ë¡œê·¸ê°€ ìˆê¸°ë•Œë¬¸ì— ì •ìƒë¦¬í„´ í•´ì•¼ëœë‹¤.
  
}

function loop_system_red(player, currTurn) {
  //////////////////////////////////////////////////////////////////////////////////////////
  /// ì‹œìŠ¤í…œ 2. ë ˆë“œì¡´
  
  var logtxt = [];
  
  // 1. í„´ì¡°ê±´ ì•ˆë§ì„ ê²½ìš° ì¡°ìš©íˆ ë¦¬í„´ì²˜ë¦¬
  // 1-1) 15í„´ ë¯¸ë§Œë¯¸ë©´ ë¦¬í„´
  if(currTurn < redStart) return ['ì—†ìŒ', player];
  // 1-2) í„´ì´ 10í„´ì´ë‚˜ ê·¸ ì´í›„ë¼ë©´, ì¦‰ ì‹¤í–‰ì¡°ê±´ì´ ë§ë‹¤ë©´ ìê¸°ì¥ ë¡œë“œ
  var red = readZone('ë ˆë“œì¡´');
  var currRed = red;
  
  // 2. ë ˆë“œì¡´ ë²”ìœ„ë‚´ í”Œë ˆì´ì–´ ì²´í¬í•´ì„œ HPë¥¼ í†µì§¸ë¡œ ê¹ìŒ
  // ëœë¤ ìˆœì„œë¡œ ê¹ê³  ë§ˆì§€ë§‰ í”Œë ˆì´ì–´ëŠ” ì£½ì´ì§€ ì•ŠëŠ”ë‹¤. (ì¢…ë£Œì²˜ë¦¬ì‹œ ë²„ê·¸ ë°©ì§€)
  // ì‚´ì•„ìˆëŠ” ì¸ì›ìˆ˜ë¥¼ êµ¬í•¨
  if (red != 'ì—†ìŒ') { // ë ˆë“œì¡´ ì—†ëŠ”ê±° ì•„ë‹ê²½ìš°
    player.sort(function() { return Math.random() - Math.random(); }); // í”Œë ˆì´ì–´ ì „ì²´ ë°°ì—´ ëœë¤ ì íŒ…
    for(var i in player) { // ëª¨ë“  ëœë¤ì íŒ…ëœ í”Œë ˆì´ì–´ì— ëŒ€í•˜ì—¬
      if(player[i][11] > 0) { // í”¼ê°€ ìˆëŠ” í”Œë ˆì´ì–´ë“¤ë§Œ ëŒ€ìƒìœ¼ë¡œ
      
        var txt = player[i][1]+player[i][2]+'ë ˆë“œì¡´ í”¼ì ê²€-';
        var deadChk = 0;

        // ì¡°ê±´1. í”Œë ˆì´ì–´ê°€ ë ˆë“œì¡´ ì•ˆìª½ì´ê±°ë‚˜
        if((player[i][15] >= red[0][0]) && (player[i][15] <= red[1][0]) && 
          (player[i][16] >= red[0][1]) && (player[i][16] <= red[1][1]))
          deadChk++, txt += "ë ˆë“œì¡´ ë™ì„œë‚¨ë¶ì„ ì˜ ì•ˆìª½ì— ìˆìŒ ";
        
        // ì¡°ê±´2. ìê¸°ì¥ì´ ì „ì²´ìê¸°ì¥ì¼ê²½ìš°, HP ì‚­ê°ëŒ€ìƒì´ë‹¤.
        if(red == 'ì „ì²´') deadChk++, txt += "ì•ˆì „ì§€ëŒ€ê°€ ì•„ì˜ˆ ì—†ìŒ) "; //* ì‹¤ì œë¡œëŠ” ì¼ì–´ë‚˜ì§€ ì•Šì„ ê±°ì§€ë§Œ ë²„ê·¸ë°©ì§€ìš©ìœ¼ë¡œ..
        
        // ìƒê¸° ë‘ ì¡°ê±´ì´ ë‘˜ ì¤‘ í•˜ë‚˜ ë§Œì¡±ë  ê²½ìš°, í™•ë¥ ì²´í¬ë¥¼ ì‹¤ì‹œ.
        // í™•ë¥ ì²´í¬ê°€ ë§Œì¡±ìƒíƒœì¼ ê²½ìš° ì‚­ê°ì²˜ë¦¬
        // ë¯¸ë¦¬ ì„¤ì •ëœ í™•ë¥ ëŒ€ë¡œ HP ì‚­ê°ì²˜ë¦¬ ì‹œì‘ (ì´ê±° forë¬¸ ì•ˆìª½ì˜ ëª…ë ¹ë¬¸ì„. ë‹¹ì—°íˆ í™•ë¥ ì€ ë§¤ í”Œë ˆì´ì–´ë§ˆë‹¤ ë‹¤ë¦„)
        if(deadChk > 0 && randomPercent(redPerc) == true) {
          txt+= player[i][2] + player[i][1] + "("+player[i][15]+"," + player[i][16]+")" + ' in  ë ˆë“œì¡´(' + red[0][0] + "," + red[0][1] + " ~ " + red[1][0] + ", " + red[1][1] + ') â‡’ ì¡°ê±´ì´ ë§ì•„ í­ê²©ì²˜ë¦¬í•©ë‹ˆë‹¤.';
          var lives = 0; for(var j in player) if(player[j][11] > 0) lives++; // ìƒì¡´ì ëª…ìˆ˜(HP 1 ì´ìƒìˆëŠ”ë†ˆ ëª…ìˆ˜ ) êµ¬í•´ì„œ
          //log(player[i][1]+player[i][2]+': ìƒì¡´ì ëª…ìˆ˜ëŠ” ' + lives + "ëª…ì´ë‹¤!");
          if(lives >= 2) { // ìƒì¡´ììˆ˜ê°€ 2 ì´ìƒì´ë©´ í”¼ ì œë¡œí™” ì‹¤í–‰ (*2ëª… ì´ìƒì´ë©´ ì•ˆí•˜ê³  ë„˜ì–´ê°„ë‹¤)
            //log(player[i][1]+player[i][2]+': ìƒì¡´ì 2ëª…ì´ìƒì´ì–´ì„œ í”¼ê¹Œê¸°ë¶€ ë“¤ì–´ì™”ë‹¤! ë ˆë“œì¡´ í”¼ë¥¼ê¹ë‹¤.');
            player[i][11] = 0; // í”¼ ì œë¡œí™”
            //log(player[i][1]+player[i][2]+'ëŠ” ë ˆë“œì¡´ì—ì„œ '+redPerc+'%ì˜ í™•ë¥ ì„ ëš«ê³  í­ê²©ì„ ë§ì•„ì„œ ì£½ì—ˆë‹¤.');
            logtxt.push(/*txt*/ "ğŸ”¥ë ˆë“œì¡´ğŸ’¥ğŸ’¥ğŸ’¥" + 'â˜ ï¸' + player[i][2] + " "+player[i][1] + "ì•„ì–! ë„ˆë¬´ ë”°ë”í•´....âš°ï¸ğŸ˜‡ï¸âš°ï¸ğŸ˜‡ï¸âš°ï¸ğŸ˜‡ï¸"); // ìê¸°ì¥ ë§ê³  ì‚¬ë§ ì‹œ ë©˜íŠ¸
            for(var k in player) if(player[k][26]==i) player[k][26]='x'; // í˜¹ì‹œ ì´ì‹œì ì—ì„œ í•´ë‹¹ í”Œë ˆì´ì–´ê°€ ì£½ì—¬ì„œ ë£¨íŒ…í•´ì•¼ ë˜ëŠ” ì‹œì²´(ì •ë²Œì)ê°€ ìˆë‹¤ë©´, ëª¨ë‘ ì—†ì• ë²„ë¦°ë‹¤.
            player[i][25] = currTurn; // ì£½ì€ ì‹œì ì˜ í„´ì„ í”Œë ˆì´ì–´ ë°°ì—´ì— ê¸°ë¡ì²˜ë¦¬            
          }
        } // HP ì‚­ê°ì²˜ë¦¬ ë
        //log(txt);
      } // hp ìˆëŠ” í”Œë ˆì´ì–´ ëŒ€ìƒ IFë¬¸ ë
    } // í”Œë ˆì´ì–´ë‹¹ forë¬¸ ì²˜ë¦¬ ë
    player.sort(function(a, b) { return a[0] - b[0]; }); // í”Œë ˆì´ì–´ ì „ì²´ ë°°ì—´ idx ì •ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì¬ë³µêµ¬
  }
  
  // 3. 12í„´ë¶€í„° ë§¤ íŠ¹ì •í„´ì”©, ìê¸°ì¥ í¬ê¸°ê°€ minimum ì•„ë˜ê°€ ì•„ë‹Œì´ìƒ ì¼ì • í„´ë§ˆë‹¤ ë ˆë“œì¡´ ì¬ì„¤ì •í•¨.
  var mag = readZone('ìê¸°ì¥');
  var magHeight = Math.abs((mag[1][0] - 1) - mag[0][0]);
  var magWidth = Math.abs((mag[1][1] - 1) - mag[0][1]);
  if(magWidth <= redDiffLimit || magHeight <= redDiffLimit || mag == 'ì—†ìŒ' || mag == 'ì „ì²´') { // ìê¸°ì¥ì˜ ë„ˆë¹„ë‚˜ ë†’ì´ê°€ ì„¤ì •ëœ ìµœì†Œì¹˜ì´ê±°ë‚˜ ê·¸ ì´í•˜ë¡œ ì¶•ì†Œë  ê²½ìš°
    red = 'ì—†ìŒ';
    writeZone('ë ˆë“œì¡´', red);
  } else if(currTurn % redFreq == 0 && currTurn >= 12) { // 12í„´ ì´í›„ redFreqí„´(í˜„ì¬ 5í„´)ì´ ëŒì•„ì˜¬ ë•Œë§ˆë‹¤ ë ˆë“œì¡´ ì¬ì§€ì • ì‹¤í–‰
    // ìƒˆë¡œìš´ ë ˆë“œì¡´ì„ ì§€ì •í•œë‹¤.
    red = [[0, 0], [0, 0]]; // ë³€ìˆ˜ì´ˆê¸°í™”
    // ë ˆë“œì¡´ ìƒì„±ì˜ì—­ì€ ìê¸°ì¥ ì•ˆì—ì„œ ì™„ì „íˆ ëœë¤ì´ë©°, ìµœëŒ€ í•œì¹¸ê¹Œì§€ ë²—ì–´ë‚ ìˆ˜ ìˆë‹¤.
    red[0][0] = mag[0][0] + Math.floor(Math.random() * (magHeight)); // row ìœ—ì¢Œí‘œ
    if(red[0][0] <= 0) red[0][0] = 1;
    if(red[0][0] >= 19) red[0][0] = 19;
    red[0][1] = mag[0][1] + Math.floor(Math.random() * (magWidth + 1)); // col ì™¼ìí‘œ
    if(red[0][1] <= 0) red[0][1] = 1;
    if(red[0][1] >= 20) red[0][1] = 19;
    // ë ˆë“œì¡´ì˜ í¬ê¸°ëŠ” 2 x 2 ê³ ì •ì´ë‹¤.
    red[1][0] = red[0][0] + 1; // row ì•„ë˜ì¢Œí‘œ
    red[1][1] = red[0][1] + 1; // col ì˜¤ë¥¸ì¢Œí‘œ
    
    // 4. ë³€ê²½ëœ ë ˆë“œì¡´ ë° ë¡œê·¸ ê¸°ë¡
    writeZone('ë ˆë“œì¡´', red);
    logtxt.push("ğŸ”¥ìƒˆë¡œìš´ ë ˆë“œì¡´ì— í­ê²©ì´ ìŸì•„ì§‘ë‹ˆë‹¤! " + zoneTxt(currRed) +" â‡’ " + zoneTxt(red));
    
  }
  
  if(logtxt.length == 0) logtxt = 'ì—†ìŒ'; // ë ˆë“œì¡´ì— ë‹¹í•œì‚¬ëŒë„ ì•„ë¬´ë„ ì—†ê³ , ë ˆë“œì¡´ ë°”ë€ŒëŠ” í„´ë„ ì•„ë‹ˆë¼ë©´ logtxtë¥¼ []ì—ì„œ 'ì—†ìŒ'ìœ¼ë¡œ ë°”ê¿”ì¤€ë‹¤.
  return [logtxt, player]; // ë ˆë“œì¡´ìœ¼ë¡œ ë§ì•„ì£½ì€ ì¸ì›ì´ ìˆìœ¼ë©´ ì´ì‹œì ì—ì„œ ë¡œê·¸ê°€ ìˆê¸°ë•Œë¬¸ì— ì •ìƒë¦¬í„´ í•´ì•¼ëœë‹¤.
}

function loop_system_giftBox() {
  //////////////////////////////////////////////////////////////////////////////////////////
  /// ì‹œìŠ¤í…œ 3. ê³µì¤‘ë³´ê¸‰
  // ê¸°ë³¸ ë³€ìˆ˜ ì¤€ë¹„
  // í˜„ì¬ ë² ì´ìŠ¤ ë§›ì§‘ì´ 36í–‰(idx ~33)ê¹Œì§€ ì°¨ì§€í•˜ê³  ìˆìœ¼ë¯€ë¡œ, getLastRowë¥¼ í•˜ë©´ ê²œì´ˆê¸° 36ìœ¼ë¡œ êµ¬í•´ì§.
  // ì¦‰ ê¸°ë³¸ì ìœ¼ë¡œ ë³´ê¸‰ìƒìëŠ” 37í–‰ë¶€í„° ì‹œì‘í•˜ê²Œ ëœë‹¤.
  
  var mag = readZone('ìê¸°ì¥');
  var magHeight = Math.abs((mag[1][0] - 1) - mag[0][0]);
  var magWidth = Math.abs((mag[1][1] - 1) - mag[0][1]);
  //debugConsoleLog(doubleArrayToText(mag));

  // ìê¸°ì¥ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì „ì²´ ì˜ì—­ì´ ìê¸°ì¥ ì´ ê±° ë‚˜
  // ë‚¨ì€ ë§µí­ì´ 5ì´í•˜(ë””í´íŠ¸ê°’,ì„¤ì •ë³€ê²½ê°€ëŠ¥) ì´ ê±° ë‚˜
  // í™•ë¥ (ê¸°ë³¸ 10%)êµ´ë¦¼ì— ì‹¤íŒ¨í•´ë„ ë¦¬í„´í•œë‹¤.
  if(mag == 'ì „ì²´' || mag == 'ì—†ìŒ' || randomPercent(giftFreq) == false || magHeight <= presentDiffLimit || magWidth <= presentDiffLimit ) {
    //debugConsoleLog("ìê¸°ì¥ì´ ì—†ê±°ë‚˜ ì „ì²´ê±°ë‚˜ ë³´ê¸‰ìƒì„± í™•ë¥ ì´ ì•ˆë©ë‹ˆë‹¤.");
    return 'ì—†ìŒ';
  } else {
    var logtxt = [];
    var fRow = mg_matzip.getLastRow();
    
    //debugConsoleLog('ì¢Œí‘œê¸ê¸°');
    // ìê¸°ì¥ìœ¼ë¡œë¶€í„° ì•ˆì „í•œ ì•ˆì „ì§€ëŒ€ ì˜ì—­ ì•ˆìª½ì˜ ì•„ë¬´ ì¢Œí‘œë‚˜ êµ¬í•œë‹¤.
    var row = (mag[0][0]+1) + Math.floor(Math.random() * (mag[1][0]-mag[0][0]-1));
    var col = (mag[0][1]+1) + Math.floor(Math.random() * (mag[1][1]-mag[0][1]-1));
    
    //debugConsoleLog('ì¢Œí‘œ: ' + row + ',' + col);
    // DBë°˜ì˜ ë° ë©”ì„¸ì§€ ì¶œë ¥
    logtxt.push("í•˜ëŠ˜ì—ì„œ ë¹¨ê°„ ë§›ì´ ë‚´ë ¤ì™”ë‹¤! ğŸ @ (" + row + ", " + col + ")");
    
    //debugConsoleLog(logtxt[0]);
    mg_matzip.getRange(fRow+1, 1, 1, 6).setValues([[fRow-3, false, "ğŸ", "ë¹¨ê°„ ë§›", row, col]]); // ê¸°ë³¸ ë³€ìˆ˜ ì„¸íŒ… (ë°©ë¬¸ê°€ëŠ¥=true)
    
    //debugConsoleLog('ë³´ê¸‰ ê¸°ë³¸ë³€ìˆ˜ì„¸í‹´ ì™„ë£Œ');
    mg_matzip.getRange(fRow+1, 7, 1, mg_matzip.getLastColumn()-6).setValue(true); // ë‚˜ë¨¸ì§€ ë³€ìˆ˜ false

    //debugConsoleLog('ë³´ê¸‰ ì „ë³€ìˆ˜ì„¸íŒ… ì™„ë£Œ');
    // logtxt ì¡´ì¬ì—¬ë¶€ì— ë”°ë¼ì„œ ë‹¤ë¥´ê²Œ ë¦¬í„´
    return logtxt;
  }
}

/////////////// ì‹œíŠ¸ì—ì„œ ì¡´ì˜ í˜•íƒœë¥¼ ì½ì–´ì˜´
/////////////// ë°˜í™˜í˜•íƒœ: [ ì¢Œìƒì²«ìœ„í—˜ì [r , c] , ìš°í•˜ì²«ìœ„í—˜ì [r , c] ]
function readZone(type, debug) {
/* ìƒ˜í”Œì‚¬ìš©ë²•
   log(readZone('ìê¸°ì¥')[0]);
   log(readZone('ìê¸°ì¥')[1]);
   log(readZone('ë ˆë“œì¡´')[0]);
   log(readZone('ë ˆë“œì¡´')[1]);
*/
  if(debug === undefined) { // í†µìƒì‹œ
    if(type == 'ìê¸°ì¥') var pos = mg_main.getRange(8, 5);
    else if(type == 'ë ˆë“œì¡´') var pos = mg_main.getRange(9, 5);
  } else { // ë””ë²„ê·¸ì‹œ
    if(type == 'ìê¸°ì¥') var pos = mg_inf.getRange(97, 23);
    else if(type == 'ë ˆë“œì¡´') var pos = mg_main.getRange(98, 23);
  }
  var txt = pos.getValue();
  if(txt == 'ì—†ìŒ') { // 1) ì¥ ìì²´ê°€ ì—†ë‹¤ë©´
    return 'ì—†ìŒ';
  } else if(txt == 'ì „ì²´') { // 2) ë§‰íŒì´ë¼ ìê¸°ì¥ì´ ì „ì²´ ì˜ì—­ì— ê±¸ì³ ìˆë‹¤ë©´
    return 'ì „ì²´';
  } else { // 3) ê·¸ ì™¸ì˜ ê²½ìš° ì¦‰ ìê¸°ì¥ì´ ì •ìƒì ìœ¼ë¡œ ë²”ìœ„ë¥¼ ê°–ê³  í˜•ì„±ë˜ì–´ ìˆì„ ë•Œ
    txt = txt.split(" ~ ");
    for(var i in txt) {
      txt[i] = txt[i].split(",");
      txt[i][0] = Number(txt[i][0]); // í˜¹ì‹œëª¨ë¥´ë‹ˆ ìˆ«ìí™”ì‹œì¼œì¤Œ
      txt[i][1] = Number(txt[i][1]); // í˜¹ì‹œëª¨ë¥´ë‹ˆ ìˆ«ìí™”ì‹œì¼œì¤Œ
    }
    return txt;
  }
}

/////////////// ë°”ë€ ì¡´ì˜ í˜•íƒœë¥¼ ì‹œíŠ¸ë³€ìˆ˜ ìë¦¬ì— ë°˜ì˜í•¨
function writeZone(type, zone) {
/* ìƒ˜í”Œì‚¬ìš©ë²•
   writeZone('ìê¸°ì¥', [[1,2],[3,4]]);
   writeZone('ë ˆë“œì¡´', [[5,6],[7,8]]);
   writeZone('ìê¸°ì¥', 'ì—†ìŒ');
   writeZone('ë ˆë“œì¡´', 'ì „ì²´');
*/
  if(type == 'ìê¸°ì¥') var pos = mg_main.getRange(8, 5);
  else if(type == 'ë ˆë“œì¡´') var pos = mg_main.getRange(9, 5);
  
  if(zone == 'ì—†ìŒ') var txt = 'ì—†ìŒ';
  else if(zone == 'ì „ì²´') var txt = 'ì „ì²´';
  else var txt = zone[0][0] + "," + zone[0][1] + " ~ " + zone[1][0] + "," + zone[1][1];
  pos.setValue(txt);
}

/////////////// í˜„ì¬ ìê¸°ì¥ or ë ˆë“œì¡´ í˜•íƒœë¥¼ ë¡œê·¸í…ìŠ¤íŠ¸ ì¶œë ¥ìš© ë¬¸ìì—´ë¡œ í‘œí˜„í•´ì¤Œ
function zoneTxt(zone) {
  if (zone == 'ì—†ìŒ') return '(ì—†ìŒ)';
  else {
    var txt = "(";
    txt += zone[0][0] + ", " + zone[0][1];
    txt += ") ~ (";
    txt += zone[1][0] + ", " + zone[1][1];
    txt += ")";
    return txt;
  }
}

/////////////// ê²Œì„ì´ ì •ìƒì§„í–‰ëë‹¤ë©´ ì§€ê¸ˆ ì‹œì ì— ëª‡í„´ê¹Œì§€ ì§„í–‰ëì–´ì•¼ í•˜ëŠ”ì§€ êµ¬í•´ì¤Œ.
function getEstimatedRoutines() {
  var hours = new Date().getHours();
  var mins = new Date().getMinutes();
  var currMins = hours * 60 + mins;
  //debugConsoleLog(hours); // í˜„ì¬ ì‹œê°„ì˜ ì‹œê°„ê°’
  //debugConsoleLog(mins); // í˜„ì¬ ì‹œê°„ì˜ ë¶„ê°’
  //debugConsoleLog(hours + ":" + mins); // í˜„ì¬ ì‹œê°„ ë° ë¶„ í‘œì‹œ
  //debugConsoleLog(currMins); // ìì •ìœ¼ë¡œë¶€í„° í˜„ì¬ì‹œê°ì˜ ì´ ë¶„ìˆ˜ í‘œì‹œ

  
  var sHours = nextGameStartHour * 60 ; // ê²Œì„ ê°œì‹œ ì‹œì ì˜ ë¶„ê°’
  var currRoutineTurn = Math.ceil((currMins - sHours) / (60 * routineHour)); // í˜„ì¬ ì§„í–‰ë˜ì—ˆì–´ì•¼ í•  ë£¨í‹´ê°¯ìˆ˜ = {(ê²Œì„ê°œì‹œí›„ ê²½ê³¼ëœ ë¶„ìˆ˜) / (ë£¨í‹´ì£¼ê¸° ë¶„ìˆ˜)}ì˜ ì˜¬ë¦¼ê°’
  // ì˜¬ë¦¼ê°’(ceil)ì„ êµ³ì´ ì“°ëŠ” ì´ìœ ëŠ”, ë‚´ë¦¼ê°’ìœ¼ë¡œ í•˜ë©´ 10ì‹œ 1ë¶„~14ë¶„ ì‚¬ì´ì—ëŠ” 0í„´ê¹Œì§€ë°–ì— ì‹¤í–‰ì„ ì•ˆ í•˜ê¸° ë•Œë¬¸ì„. ì˜¬ë¦¼ê°’ìœ¼ë¡œ í•´ë†”ì•¼ 10ì‹œ 1ë¶„ì— 1í„´ê¹Œì§€ ì‹¤í–‰í•¨.
  // ì²« ì‹œì‘ì´ 1í„´(ë‚™í•˜ì‚° ë§‰ í´ëŠ”ì‹œì )ì´ê¸° ë•Œë¬¸ì—, ì²˜ìŒë¶€í„° ì˜¬ë¦¼ê°’ìœ¼ë¡œ í‘œí˜„í•˜ëŠ”ê²Œ íƒ€ë‹¹í•¨.
  
  return currRoutineTurn;
}

//////////////// í˜„ì¬ ë¼ìš´ë“œì˜ ìê¸°ì¥ ì¤‘ì‹¬ì¢Œí‘œê°’ì„ ë¦¬í„´í•´ì¤Œ. ///////////////
function getmagRC(debug) {
  // ë¼ìš´ë“œê°’ì„ ì‹œë“œë¡œ í•´ì„œ 1 ~ 380 ì‚¬ì´ì˜ ë‚œìˆ˜ ìƒì„±
  var currRound = mg_main.getRange(6,5).getValue();
  var roundRandomSeed = Math.floor(randomBySeed(currRound) * (19 * 20)) + 1; // ì˜¬ë¦¼ê°’(0~1ëœë¤ * 380) + 1 = <1 ~ 380 ì‚¬ì´ì˜ ê°’>
  var magR = Math.floor(roundRandomSeed/20) + 1;
  var magC = roundRandomSeed % 20;
  if(debug == 'on') debugConsoleLog(currRound + ' ë¼ìš´ë“œì˜ ëœë¤ì¢Œí‘œê°’=' + roundRandomSeed + "(" + magR + ", " + magC + ")");
  return [magR, magC];
}

//////////////// í˜„ì¬ ë¼ìš´ë“œì˜ ìê¸°ì¥ ì¤‘ì‹¬ì¢Œí‘œê°’ì— ë”°ë¼ ê¸°ìš¸ê¸° í™•ë¥ ì„ êµ¬í•´ì¤Œ. ///////////////
function getmagRCModifications() {
  // ìê¸°ì¥ ì¤‘ì‹¬ì¢Œí‘œê°’ ë¡œë“œ
  var magCenter = getmagRC();
  var magR = magCenter[0];
  var magC = magCenter[1];
  
  // ì¢Œí‘œê°’ì„ random()ì˜ í”Œë§ˆ ë³´ì •ìš© ê°’ìœ¼ë¡œ í™˜ì‚°í•¨.
  // ì˜ˆë¥¼ë“¤ì–´ ë§Œì•½ ì¢Œí‘œì˜ ë²”ìœ„ê°€ 1~20ì´ë¼ë©´, ë³´ì •ìš© ê°’ì€ -0.5 ~ +0.5ê°€ ë¨.
  // ìµœì¢… ìê¸°ì¥ ë°©í–¥ì€ random() + ë³´ì •ê°’ì´ 0.5ë¥¼ ë„˜ëŠëƒ ë§ˆëŠëƒë¡œ ë”°ì§€ë¯€ë¡œ,
  // -0.5ë©´ ê±°ì˜ ê°ì†Œ í™•ì •, +0.5ëŠ” ê±°ì˜ ì¦ê°€ í™•ì •ì´ë¼ ë³´ë©´ ë¨.
  var modifitionR = (magR-10)/20;
  var modifitionC = (magC-10.5)/20;
  return [modifitionR, modifitionC];
}